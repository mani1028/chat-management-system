<!DOCTYPE html>
<html>
<head>
    <title>Chat #{{ chat.id }} - Agent View</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .chat-window { height: 500px; display: flex; flex-direction: column; background: #fff; border: 1px solid #ccc; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .chat-input { padding: 15px; border-top: 1px solid #eee; background: #f8f9fa; display: flex; gap: 10px; }
        
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; line-height: 1.4; position: relative; word-wrap: break-word; }
        
        .msg-customer { background: #e9ecef; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-agent { background: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .msg-info { font-size: 11px; margin-bottom: 2px; opacity: 0.8; }
        .system-notice { text-align: center; font-size: 12px; color: #888; margin: 10px 0; font-style: italic; }
    </style>
</head>
<body>
    <div class="navbar">
        <div style="display:flex; align-items:center;">
            <a href="{{ url_for('agent.dashboard') }}" style="color:white; text-decoration:none; margin-right:20px;">&larr; Back</a>
            <span>Chatting with: <strong>{{ chat.customer_name }}</strong></span>
        </div>
        <a href="{{ url_for('agent.close_chat', chat_id=chat.id) }}" class="btn btn-danger">End Chat</a>
    </div>

    <div class="container" style="max-width: 800px;">
        <div class="chat-window">
            <div id="messages" class="chat-messages">
                <div class="system-notice">Chat started: {{ chat.created_at }}</div>
                {% for msg in messages %}
                <div class="msg msg-{{ msg.sender_type }}">
                    <div class="msg-info">{{ msg.sender_name }}</div>
                    {{ msg.message }}
                </div>
                {% endfor %}
            </div>
            <div class="chat-input">
                <input type="text" id="msgInput" placeholder="Type your message..." autocomplete="off">
                <button onclick="sendMsg()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const chatId = {{ chat.id }};
        const agentName = "{{ current_user.name }}";
        const messagesDiv = document.getElementById('messages');

        // Auto-scroll to bottom on load
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        socket.on('connect', () => {
            console.log("Connected to Chat Room:", chatId);
            socket.emit('join_chat', { chat_id: chatId });
        });

        socket.on('new_message', (data) => {
            const div = document.createElement('div');
            div.className = `msg msg-${data.sender_type}`;
            div.innerHTML = `
                <div class="msg-info">${data.sender_name}</div>
                ${data.message}
            `;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        function sendMsg() {
            const input = document.getElementById('msgInput');
            if(!input.value.trim()) return;

            socket.emit('agent_message', {
                chat_id: chatId,
                message: input.value,
                agent_name: agentName
            });
            input.value = '';
            input.focus();
        }

        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMsg();
        });
    </script>
</body>
</html>